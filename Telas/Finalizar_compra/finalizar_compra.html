<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Restaurante</title>
    <link rel="stylesheet" href="finalizar_compra.css">
    
    <style>
        .resumo h4 { color: #ff7a3d; }
    </style>
</head>

<body>

    <div class="container">
        <h2>Finalizar Compra</h2>

        <div class="resumo"></div>

        <form id="formPedido">

            <label for="nome">Nome:</label>
            <input id="nome" type="text" placeholder="Seu nome completo" required>

            <label for="telefone">Telefone:</label>
            <input id="telefone" type="tel" placeholder="(11) 99999-9999" required maxlength="15">

            <label for="endereco">Endereço de Entrega:</label>
            <textarea id="endereco" rows="3" placeholder="Rua, número, bairro..." required></textarea>

            <label for="pagamento">Método de Pagamento:</label>
            <select id="pagamento" required>
                <option value="">Selecione</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Crédito">Cartão de Crédito</option>
                <option value="Débito">Cartão de Débito</option>
                <option value="Pix">Pix</option>
            </select>

            <label for="obs">Observações:</label>
            <textarea id="obs" rows="2" placeholder="Alguma observação? (opcional)"></textarea>

            <button type="submit">Confirmar Pedido</button>
        </form>
    </div>

<script>
    const DELIVERY_FEE = 10;
    
    const getCart = () => JSON.parse(localStorage.getItem("sabor_arte_cart") || "{}");
    const clearCart = () => localStorage.removeItem("sabor_arte_cart");
    const money = n => n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

    const mostrarMensagem = (texto, erro = false) => {
        let msg = document.querySelector(".message");

        if (!msg) {
            msg = document.createElement("p");
            msg.classList.add("message");
            document.querySelector("#formPedido").appendChild(msg);
        }

        msg.textContent = texto;
        msg.style.color = erro ? "#ff4d4d" : "#28a745";
        msg.style.fontWeight = "bold";
        msg.style.marginTop = "15px";
        msg.style.fontSize = "16px";
    };

    function applyPhoneMask(e) {
        let input = e.target;
        let value = input.value.replace(/\D/g, "");
        let formattedValue = '';

        if (value.length > 11) value = value.substring(0, 11);

        if (value.length > 0) formattedValue += '(' + value.substring(0, 2);
        if (value.length > 2) formattedValue += ') ' + value.substring(2, value.length < 7 ? 6 : 7);
        if (value.length > 6) formattedValue += '-' + value.substring(7, 11);

        input.value = formattedValue;
    }

    function renderSummary() {
        const cart = getCart();
        const items = Object.values(cart);
        const resumoDiv = document.querySelector(".resumo");
        
        if (items.length === 0) {
            resumoDiv.innerHTML = '<p style="color: red; font-weight: bold;">Seu carrinho está vazio. Redirecionando...</p>';
            setTimeout(() => window.location.href = "../Carrinho_Vazio/carrinho_vazio.html", 2000);
            return { subtotal: 0, total: 0, items: [] };
        }

        let subtotal = 0;
        let summaryHTML = '<h3>Seu Pedido</h3><ul style="list-style-type:none;padding:0;">';

        const finalItems = items.map(item => {
            const itemTotal = item.preco * item.quantity;
            subtotal += itemTotal;

            summaryHTML += `
                <li style="margin-bottom:5px;border-bottom:1px dotted #ccc;padding-bottom:5px;">
                    ${item.quantity}x ${item.nome_prato} (${money(item.preco)} cada) -
                    <span style="font-weight:bold;">${money(itemTotal)}</span>
                </li>`;

            return {
                id: item.id,
                nome_prato: item.nome_prato,
                quantidade: item.quantity,
                preco: item.preco,
                total_item: itemTotal,
                imagem: item.imagem,
                descricao: item.descricao
            };
        });

        const total = subtotal + DELIVERY_FEE;

        summaryHTML += `</ul>
            <hr>
            <p>Subtotal: <strong>${money(subtotal)}</strong></p>
            <p>Taxa de Entrega: <strong>${money(DELIVERY_FEE)}</strong></p>
            <h4>Total Geral: <strong>${money(total)}</strong></h4>
            <hr>`;

        resumoDiv.innerHTML = summaryHTML;

        return { subtotal, total, finalItems };
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("#formPedido");
        const button = form.querySelector("button");
        const telefoneInput = document.querySelector("#telefone");

        telefoneInput.addEventListener("input", applyPhoneMask);

        const { total, finalItems } = renderSummary();
        if (total === 0) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const nome = document.querySelector("#nome").value.trim();
            const telefone = telefoneInput.value.replace(/\D/g, "");
            const endereco = document.querySelector("#endereco").value.trim();
            const pagamento = document.querySelector("#pagamento").value;
            const obs = document.querySelector("#obs").value.trim();
            
            const token = localStorage.getItem("auth_token"); 

            if (!token) {
                mostrarMensagem("Sessão expirada. Por favor, faça login novamente.", true);

                setTimeout(() => {
                    window.location.href = "../../Telas/Login/login.html";
                }, 2000);
                return;
            }

            if (!nome || telefone.length < 10 || !endereco || !pagamento) {
                mostrarMensagem("Preencha todos os campos corretamente.", true);
                return;
            }

            button.disabled = true;
            button.textContent = "Confirmando...";

            try {
                const response = await fetch("/api/finalizar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nome,
                        telefone,
                        endereco,
                        pagamento,
                        observacoes: obs || "Nenhuma",
                        itens: finalItems,
                        total
                    })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error);

                clearCart();
                mostrarMensagem("Pedido finalizado com sucesso!", false);

                button.textContent = "Pedido Enviado!";

                setTimeout(() => {
                    window.location.href = "../Lista_pratos/lista_pratos.html";
                }, 3000);

            } catch (error) {
                mostrarMensagem("Erro ao finalizar pedido: " + error.message, true);
            } finally {
                if (button.textContent !== "Pedido Enviado!") {
                    button.disabled = false;
                    button.textContent = "Confirmar Pedido";
                }
            }
        });
    });
</script>

</body>
</html>
